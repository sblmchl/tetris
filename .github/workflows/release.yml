name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.read.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Read Cargo.toml version
        id: read
        run: |
          version=$(sed -n 's/^version = "\([^"]*\)".*/\1/p' Cargo.toml | head -n 1)
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Recreate release and tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="v${{ steps.read.outputs.version }}"

          gh release delete "$tag" -y || true

          git tag -d "$tag" 2>/dev/null || true
          git push origin ":refs/tags/$tag" 2>/dev/null || true

          gh release create "$tag" \
            --title "$tag" \
            --target "$GITHUB_SHA" \
            --draft=false

  build:
    needs: release

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            bin: ./tetris
          - os: windows-latest
            bin: ./tetris.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.release.outputs.version }}" "target/release/${{ matrix.bin }}" --clobber
